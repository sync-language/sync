name: "iOS"

on:
    workflow_dispatch:
    workflow_call:

jobs:
  ios:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install CMake
      uses: lukka/get-cmake@latest 
    - name: Configure CMake
      run: cmake -S . -B build -DSYNC_LIB_DOCTEST_ADD_CTESTS=OFF -DSYNC_LIB_ASAN=OFF -DCMAKE_TOOLCHAIN_FILE=scripts/vendor/ios-cmake/ios.toolchain.cmake -G "Xcode" -DPLATFORM=OS64 -DSYNC_LIB_WITH_TESTS=ON
    - name: Build
      run: cmake --build build --config Debug --parallel
    - name: Create iOS Simulator
      run: |
        sudo softwareupdate --install-rosetta --agree-to-license || true
        sudo xcodebuild -license accept || echo "License already accepted"
        xcrun simctl list devices
        DEVICE_UUID=$(xcrun simctl create "SyncLibTests" com.apple.CoreSimulator.SimDeviceType.iPhone-17 com.apple.CoreSimulator.SimRuntime.iOS-26-0 2>/dev/null || xcrun simctl create "SyncLibTests" com.apple.CoreSimulator.SimDeviceType.iPhone-16 com.apple.CoreSimulator.SimRuntime.iOS-18-0)
        echo "DEVICE_UUID=$DEVICE_UUID" >> $GITHUB_ENV
    - name: Test
      run: |
        echo "sim boot"
        xcrun simctl boot $DEVICE_UUID

        echo "install tests"
        xcrun simctl install $DEVICE_UUID build/Debug-iphoneos/SyncLibTests.app

        echo "log stream"
        xcrun simctl spawn $DEVICE_UUID log stream --predicate 'process == "SyncLibTests"' --style compact &
        LOG_PID=$!

        echo "launch tests"
        xcrun simctl launch --console-pty $DEVICE_UUID org.synclang
        APP_EXIT_CODE=$?

        echo "log flush"
        sleep 2
        kill $LOG_PID 2>/dev/null || true

        echo "Sync Tests exited with: $APP_EXIT_CODE"

        xcrun simctl spawn $DEVICE_UUID log show --last 1m --predicate 'process == "SyncLibTests"' --style compact || true

        exit $APP_EXIT_CODE


    # - name: Test
    #   run: |
    #     xcodebuild clean test -project Deckster.xcodeproj -scheme "Deckster" -configuration Staging -destination 'platform=iOS Simulator,name=iPhone 16'
         