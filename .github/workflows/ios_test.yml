name: "iOS"

on:
    workflow_dispatch:
    workflow_call:

jobs:
  ios:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install CMake
      uses: lukka/get-cmake@latest 
    - name: Configure CMake
      run: cmake -S . -B build -DSYNC_LIB_DOCTEST_ADD_CTESTS=OFF -DSYNC_LIB_ASAN=OFF -DCMAKE_TOOLCHAIN_FILE=scripts/vendor/ios-cmake/ios.toolchain.cmake -G "Xcode" -DPLATFORM=OS64 -DSYNC_LIB_WITH_TESTS=ON
    - name: Build
      run: cmake --build build --config Debug --parallel
    - name: Create iOS Simulator
      run: |
        sudo softwareupdate --install-rosetta --agree-to-license || true
        sudo xcodebuild -license accept || echo "License already accepted"
        xcrun simctl list devices
        DEVICE_UUID=$(xcrun simctl create "SyncLibTests" com.apple.CoreSimulator.SimDeviceType.iPhone-17 com.apple.CoreSimulator.SimRuntime.iOS-26-0 2>/dev/null || xcrun simctl create "SyncLibTests" com.apple.CoreSimulator.SimDeviceType.iPhone-16 com.apple.CoreSimulator.SimRuntime.iOS-18-0)
        echo "DEVICE_UUID=$DEVICE_UUID" >> $GITHUB_ENV
    - name: Test
      run: |
        echo "sim boot"
        xcrun simctl boot $DEVICE_UUID

        echo "install tests"
        xcrun simctl install $DEVICE_UUID build/Debug-iphoneos/SyncLibTests.app

        echo "find app container"
        APP_CONTAINER=$(xcrun simctl get_app_container $DEVICE_UUID org.synclang)
        echo "tests installed at: $APP_CONTAINER"

        echo "binary and code signing"
        file "${APP_CONTAINER}/SyncLibTests"
        codesign -dvvv "${APP_CONTAINER}/SyncLibTests" || echo "Code signing check failed"

        echo "dynamic libraries"
        otool -L "${APP_CONTAINER}/SyncLibTests" || echo "otool failed"

        echo "run tests"
        xcrun simctl spawn --standalone $DEVICE_UUID "${APP_CONTAINER}/SyncLibTests" 2>&1
        APP_EXIT_CODE=$?

        if [ $APP_EXIT_CODE -eq 137 ]; then
          echo "killed with SIGKILL (signal 9)"
          xcrun simctl spawn $DEVICE_UUID log show --last 2m --predicate 'eventMessage contains "SyncLibTests"' --style compact
        fi

        echo "Sync tests exited with: $APP_EXIT_CODE"

        exit $APP_EXIT_CODE


    # - name: Test
    #   run: |
    #     xcodebuild clean test -project Deckster.xcodeproj -scheme "Deckster" -configuration Staging -destination 'platform=iOS Simulator,name=iPhone 16'
         