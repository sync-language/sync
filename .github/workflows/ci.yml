name: "CI"

on:
    workflow_dispatch:
    pull_request:
        branches:
            - main
        paths-ignore:
            - '**/*.yml'
            - '**/*.yaml'
    push:
        branches:
            - main
        paths-ignore:
            - '**/*.yml'
            - '**/*.yaml'

jobs:
    sync-x64:
        runs-on:
            - self-hosted
            - Linux
            - X64
        env:
            WORK_DIR: ${{ github.workspace }}/runs/${{ github.run_id }}
        steps:
            - name: Cleanup runs older than 24 hours
              run: |
                find ${{ github.workspace }}/runs -maxdepth 1 -type d -mtime +1 -exec rm -rf {} + 2>/dev/null || true

            - name: Setup workspace
              run: |
                mkdir -p ${{ env.WORK_DIR }}
                cd ${{ env.WORK_DIR }}

            - name: Checkout code
              uses: actions/checkout@v4
              with:
                path: ${{ env.WORK_DIR }}/repo
                clean: true

            - name: Run VCI tests
              working-directory: ${{ env.WORK_DIR }}/repo
              run: |
                ls
                vci run test/vci/ubuntu_x64.yml
