windows-x64:
    image: ~/vm/windows-server.qcow2
    arch: amd64
    cpus: 2
    memory: 8G
    user: Administrator
    pass: DevWin2022
    uefi: true
    steps:
        # - name: TEST 0 Copy to current directory
        #   copy:
        #     from: ./lib/src/doctest.h
        #     to: vm:./

        # - name: TEST 1 Test relative path
        #   copy:
        #     from: ./lib/src/doctest.h
        #     to: vm:C:/Users/Administrator/test.h

        # - name: TEST 2 Create directory structure
        #   run: |
        #     if not exist C:\Users\Administrator\lib mkdir C:\Users\Administrator\lib
        #     if not exist C:\Users\Administrator\lib\src mkdir C:\Users\Administrator\lib\src

        # - name: TEST 3 Copy to pre-created directory
        #   copy:
        #     from: ./lib/src/doctest.h
        #     to: vm:C:/Users/Administrator/lib/src/doctest.h

        - name: Copy Files
          copy:
            from: ./
            to: vm:C:\Users\Administrator
            exclude:
              - .git
              - .github
              - docs

        - name: Fix line endings and encoding for Windows
          run: |
            Write-Host "Converting files to UTF-8 with BOM and CRLF..."
            $utf8Bom = New-Object System.Text.UTF8Encoding $true
            $extensions = '*.c','*.cpp','*.h','*.hpp','*.cc','*.cxx','*.hxx','*.rs','*.zig'
            $files = Get-ChildItem -Recurse -Include $extensions
            Write-Host "Found $($files.Count) files to convert"
            $files | ForEach-Object {
              try {
                $path = $_.FullName
                $bytes = [IO.File]::ReadAllBytes($path)
                $content = [System.Text.Encoding]::UTF8.GetString($bytes)
                $content = $content -replace "`r`n","`n" -replace "`r","`n" -replace "`n","`r`n"
                [IO.File]::WriteAllText($path, $content, $utf8Bom)
              } catch {
                Write-Host "ERROR converting ${path}: $_"
              }
            }
            Write-Host "Conversion complete"

        - name: Valid file check
          run: Get-Item C:\Users\Administrator\lib\src\core\core.c | Select-Object Length

        - name: Check BOM presence
          run: |
            $bytes = Get-Content C:\Users\Administrator\lib\src\core\core.c -Encoding Byte -TotalCount 3
            $bom = $bytes -join ','
            Write-Host "First 3 bytes: $bom"
            if ($bom -eq '239,187,191') {
              Write-Host "UTF-8 BOM detected!"
            } else {
              Write-Host "No UTF-8 BOM found"
            }

        - name: Contents
          run: Get-Content C:\Users\Administrator\lib\src\core\core.c -TotalCount 5

        - name: Check BOM before offline
          run: |
            $testFiles = @(
              'C:\Users\Administrator\test\core\filesystem\filesystem_get_file_size_this_file_small.cpp',
              'C:\Users\Administrator\test\core\rwlock\rwlock_array_reallocation.cpp'
            )
            foreach ($file in $testFiles) {
              $bytes = Get-Content $file -Encoding Byte -TotalCount 3
              $bom = $bytes -join ','
              Write-Host "${file}: $bom"
            }

        - name: Run Subsequent Steps Offline
          offline: true

        - name: Check BOM after offline
          run: |
            $testFiles = @(
              'C:\Users\Administrator\test\core\filesystem\filesystem_get_file_size_this_file_small.cpp',
              'C:\Users\Administrator\test\core\rwlock\rwlock_array_reallocation.cpp'
            )
            foreach ($file in $testFiles) {
              $bytes = Get-Content $file -Encoding Byte -TotalCount 3
              $bom = $bytes -join ','
              Write-Host "${file}: $bom"
            }

        - name: Configure CMake
          run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug -DSYNC_LIB_DOCTEST_ADD_CTESTS=OFF -DCMAKE_CXX_FLAGS="/utf-8" -DCMAKE_C_FLAGS="/utf-8"

        - name: Check BOM before build
          run: |
            $testFiles = @(
              'C:\Users\Administrator\test\core\filesystem\filesystem_get_file_size_this_file_small.cpp',
              'C:\Users\Administrator\test\core\rwlock\rwlock_array_reallocation.cpp'
            )
            foreach ($file in $testFiles) {
              $bytes = Get-Content $file -Encoding Byte -TotalCount 3
              $bom = $bytes -join ','
              Write-Host "${file}: $bom"
            }

        - name: Build CMake
          run: cmake --build build

        - name: Run CTest
          run: ctest --test-dir build --output-on-failure